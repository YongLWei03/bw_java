<template>
  <div>
    <div class=" top">
      <Row style="font-size:16">
        <Col span="6">
        监测仓:
        <Select v-model="queryCondition.storeId" @on-change='changeStore(queryCondition.storeId)' style="width:60%">
          <Option value=null>全部</Option>
          <Option v-for="item in sotres" :value="item.id" :key="item.id">{{ item.name }}</Option>
        </Select>
        </Col>
        <Col span="6">
        区段:
        <Select v-model="queryCondition.sectionId" @on-change='changeSection(queryCondition.sectionId)' style="width:60%">
          <Option value=null>全部</Option>
          <Option v-for="item in sections" :value="item.id" :key="item.id">{{ item.name }}</Option>
        </Select>
        </Col>
      </Row>
      <div style="position: relative;float: left;width: 70px;">
        <Checkbox :indeterminate="indeterminate" :value="checkAll" size="large"
                  @click.prevent.native="handleCheckAll">全部
        </Checkbox>
      </div>
      <checkbox-group v-model="queryCondition.objDataType">
        <Checkbox v-for="(item,key) in curDataTypeList" :key="key" :label="item.val">
          <span>{{item.key}}</span>
        </Checkbox>
      </checkbox-group>
      <div style="position: relative;float: right;z-index: 1001" v-if="queryCondition.showSwitch">
        <span>总开关:</span>
        <i-switch size="large" @on-change="allControl">
          <span slot="open">ON</span>
          <span slot="close">OFF</span>
        </i-switch>
      </div>
    </div>
    <Row :gutter="16">
      <Col span="12">
      <div class="map" id="GISbox">
        <TestSmViewer ref="smViewer1"></TestSmViewer>
      </div>
      </Col>
      <Col span="12" :class="!queryCondition.showSwitch? 'data':'smallData' ">
      <Row :gutter="16" style="margin-right: 2px;">
        <Col span="12" v-for="item in Obj" :value="item.ObjName" :key="item.id">
        <SimulatedData v-bind:Obj="item" v-if="item.datatypeId==1" @changeStatus="changeStatus"></SimulatedData>
        <showSwitchData v-bind:Obj="item" v-else @changeStatus="changeStatus"></showSwitchData>
        </Col>
      </Row>
      </Col>
      <div style="position:relative;width:auto;float:right;right: 20px; ">
        <Page class="nextPage" @on-change="changePage" :total="queryCondition.total" show-total show-elevator
              :page-size="queryCondition.pageSize"></Page>
      </div>
    </Row>
  </div>
</template>
<script>
  import Modal from "../../../../components/Common/Modal/ShowMapDataModal.vue";

  // import SmViewer from "../../../../components/Common/3D/3DViewer";
  import TestSmViewer from "../../../../components/Common/3D/Test3DViewer";
  import SimulatedData from "../../../../components/UM/MAM/ShowSimulatedData";
  import showSwitchData from "../../../../components/UM/MAM/ShowSwitchData";
  import {TunnelService} from '../../../../services/tunnelService'
  import {EnumsService} from '../../../../services/enumsService'
  import {MonitorDataService} from '../../../../services/monitorDataService'
  import {SuperMapSqlQuery} from "../../../../scripts/three.js";
  import EnvironmentShow from "../../../../components/Common/TunnelDisplay/EnvironmentShow";

  export default {
    name: "detail-tunnel-environment",
    data() {
      return {
        // curHeight:450,
        dataInterval:null,
        checkAll: false,
        indeterminate: false,
        Obj: [],
        scene: null,
        detialMapId: "detialMap",
        queryCondition: {
          tunnelId: null, //监测仓ID
          storeId: null, //监测区段ID
          sectionId: null,
          objDataType: [], //监测数据类型
          monitorType: 1, //监测内容类型,1为环境
          pageNum: 1,
          pageSize: 6,
          total: 0,
          showSwitch: false
        },
        circleSize: 120,
        curDataTypeList: [],
        tunnelId: 0,
        curName: "",
        showSection: "none",
        btnStasus: true,
        tunnels: [],
        sotres: [],
        tunnelProps: [], //管廊统计数据
        tunnelPropsMax: [], //监测数据对应最大值
        sections: [], //管廊对应区段数据
        queryTypeList: [], //监测内容
        curTunnel: {
          user: "test",
          storeNum: 3,
          constructionUnit: "中建一局",
          operationUnit: "波汇科技",
          sectionNum: 10
        }, //当前管廊数据
        curSotre: {
          id: "",
          name: ""
        }, //当前监测仓数据
        curEnvData: [], //环境监测数据
        curConstructionData: [], //结构监测数据
        curSecurityData: [], //安防监测数据
        timer: null,
        timer: {
          timeoutId: null,
          intervalId: null,
          sectionId: null //保留上次section
        }
      };
    },
    watch: {
      $route: function () {
        this.tunnelId = this.$route.params.id;
        this.queryCondition.tunnelId = this.tunnelId;
        this.sotres = [];
        this.fentchData();
        this.getObjDetialData();
        this.showSection = "none";
        this.btnStasus = true;
      },
      "queryCondition.objDataType": function () {
        this.checkAllGroupChange();
      }
    },
    beforeRouteLeave(to, from, next) {
      if (to.name == '设备管理主页' || to.name == 'UMPatrolHomePage' || to.name == '虚拟巡检' || to.name == '人员定位详情'
        || to.name == '管廊安防监控列表' || to.name == '管廊环境监控列表') {
        from.meta.keepAlive = true;
        to.meta.keepAlive = true;
        this.$destroy()
        next()
      } else {
        to.meta.keepAlive = false
        from.meta.keepAlive = false
        this.$destroy()
        next()
      }
    },
    components: {
      // v_3DViewer,
      SimulatedData,
      showSwitchData,
      Modal,
      EnvironmentShow,
      // SmViewer
      TestSmViewer
    },
    mounted() {
      this.fentchData();
      this.handleCheckAll();
      this.setGIS()
      this.intervalData()
    },
    beforeDestroy(){
      this.dataInterval=null;
    },
    methods: {
      intervalData(){
        let _this=this;
        _this.dataInterval=setInterval(function(){_this.getObjDetialData()},1000);
        _this.dataInterval();
      },
      //勾选全选
      handleCheckAll() {
        if (this.indeterminate) {
          this.checkAll = false;
        } else {
          this.checkAll = !this.checkAll;
        }
        if (this.checkAll) {
          let temp = [];
          this.curDataTypeList.forEach(a => {
            temp.push(a.val);
          });
          this.queryCondition.objDataType = temp;
        }
        else {
          this.queryCondition.objDataType = [];
        }
      },
      //勾选数据类型
      checkAllGroupChange() {
        if (this.queryCondition.objDataType.length === this.curDataTypeList.length) {
          this.indeterminate = false;
          this.checkAll = true;
        } else if (this.queryCondition.objDataType.length > 0) {
          this.indeterminate = true;
          this.checkAll = false;
        } else {
          this.indeterminate = false;
          this.checkAll = false;
        }
        this.getObjDetialData();
      },
      //切换路由
      goToMoudle(path) {
        this.$router.push(path);
      },

      //变更监测仓
      changeStore() {
        this.btnStasus = false;
        //获取区段列表
        let _this = this
        TunnelService.getSectionsByStoreId(_this.queryCondition.storeId).then(
          (result) => {
            _this.sections = result.sort((a, b) => a.id - b.id);
            _this.curSotre.id = _this.sections[0].id;
            _this.queryCondition.sectionId = _this.sections[0].id;
            _this.curSotre.name = _this.sections[0].name;
            _this.getSectionsMonitorData();
          },
          (error) => {
            console.log(error)
          })
        //获取位置信息
        let curView = this.sotres.filter(
          a => a.id == this.queryCondition.storeId
        )[0].camera;
        this.changeArea(curView);
        this.checkAllGroupChange();
      },
      //变更区段
      changeSection() {
        this.curSotre.id = this.queryCondition.sectionId;
        this.curSotre.name = this.sections.filter(
          a => a.id == this.curSotre.id
        )[0].name;
        this.queryCondition.sectionId = this.sections[0].id;
        this.getSectionsMonitorData();
        this.checkAllGroupChange();
      },
      //获取数据
      fentchData() {
        this.tunnelId = this.$route.params.id;
        this.queryCondition.tunnelId = this.tunnelId;
        //获取监测内容
        EnumsService.getMonitorType().then(
          (result) => {
            _this.queryTypeList = result;
            _this.queryTypeList.forEach(a => {
              if (a.val == _this.queryCondition.monitorType) {
                _this.curDataTypeList = a.objectTypeList;
                let temp = [];
                _this.curDataTypeList.forEach(a => {
                  temp.push(a.val);
                });
                _this.queryCondition.objDataType = temp;
              }
            });
          },
          (error) => {
            console.log(error)
          })
        //获取管廊列表
        let _this = this
        TunnelService.getTunnels().then(
          (result) => {
            _this.tunnels = result;
            _this.tunnels.forEach(a => {
              if (a.id == _this.tunnelId) {
                _this.curName = a.name;
              }
            });
          },
          (error) => {
            console.log(error)
          })
        //获取管廊详细信息
        TunnelService.getTunnelDetailByTunnelId(_this.tunnelId).then(
          (result) => {
            _this.curTunnel.user = result.responsibility.name;
            _this.curTunnel.constructionUnit = result.construct.name;
            _this.curTunnel.operationUnit = result.operation.name;
          },
          (error) => {
            console.log(error)
          })
        //获取管仓列表     url：tunnels/{id}/stores
        TunnelService.getStoresByTunnelId(_this.tunnelId).then(
          (result) => {
            _this.sotres = result;
          },
          (error) => {
            console.log(error)
          })
        //获取指定管廊下共有多少管仓
        TunnelService.getStoresCountByTunnelId(_this.tunnelId).then(
          (result) => {
            _this.curTunnel.storeNum = result.val
          },
          (error) => {
            console.log(error)
          })
        //获取区段数
        TunnelService.getSectionsCountByTunnelId(_this.tunnelId).then(
          (result) => {
            _this.curTunnel.sectionNum = result.val
          },
          (error) => {
            console.log(error)
          })
      },

      //根据监测类型获取数据
      getMonitorData() {
          let _this = this;
          Promise.all([MonitorDataService.getMaxMonitorData(_this.tunnelId, _this.queryCondition.monitorType),
            MonitorDataService.getMonitorData()]).then(
            (result) => {
              _this.tunnelProps = [];
              _this.tunnelPropsMax = [];
              _this.tunnelPropsMax = result[1];
              result[0].forEach(a => {
                let temp = {};
                temp.location = a.location;
                temp.key = a.key;
                temp.val = new Number(a.val.toFixed(2));
                temp.percent =
                  temp.val /
                  _this.tunnelPropsMax.filter(
                    a => a.key == temp.key
                  )[0].val *
                  100;
                _this.tunnelProps.push(temp);
              });
            },
            (error) => {
              console.log(error)
            }
          )
      },
      //变更模型视角
      changeArea(area) {
        let _this = this;
        try {
          let location = area.split("/");
          _this.scene.camera.flyTo({
            destination: new Cesium.Cartesian3.fromDegrees(
              parseFloat(location[0]),
              parseFloat(location[1]),
              parseFloat(location[2])
            ),
            orientation: {
              heading: parseFloat(location[3]),
              pitch: parseFloat(location[4]),
              roll: parseFloat(location[5])
            }
          });
        } catch (e) {
        }
      },
      //获取监测仓具体区段的监测数据
      getSectionsMonitorData() {
          let _this = this
          MonitorDataService.getMonitorDataByStoreId(_this.curSotre.id).then(
            (result) => {
              _this.curEnvData = [];
              result.forEach(a => {
                let temp = {};
                temp.name = a.objTypeName;
                temp.value = new Number(a.cv).toFixed(2);
                temp.status =
                  new Number(temp.value) /
                  _this.tunnelPropsMax.filter(
                    a => a.key == temp.name
                  )[0].val *
                  100;
                _this.curEnvData.push(temp);
              });
            },
            (error) => {
              console.log(error)
            })
      },
      //总开关控制
      allControl(value) {
        for (var i = 0; i < this.Obj.length; i++) {
          this.Obj[i].ObjVal = value;
        }
      },

      //切换开关量控制和设备是否点击
      changeStatus(id, ObjVal, datatypeId, clickStatus) {
        if (datatypeId != 1) {
          this.Obj.filter(a => a.id == id)[0].ObjVal = ObjVal;
        }
        if (clickStatus) {
          this.Obj.forEach(b => {
            if (b.id == id) {
              b.clickStatus = clickStatus;
              this.Log.info("click " + b.id);
              SuperMapSqlQuery(
                this, SuperMapConfig.BIM_DATA,
                this.VMConfig.queryParam,
                "moid = " + b.id
              )
                .then(res => {
                  this.Log.info("查找成功", res);
                  if (res.length > 0) {
                    this.$refs.smViewer1.LookAt1(res[0], 50, -10, 5);
                  }
                })
                .then(res => {
                  this.Log.info("查找失败", res);
                });
            } else {
              b.clickStatus = !clickStatus;
            }
          });
        }
      },
      // //获取详情面板的数据
      getObjDetialData() {
        let _this = this;
        var Params = {
          tunnelId: _this.queryCondition.tunnelId,
          storeId: _this.queryCondition.storeId,
          objtypeIds: _this.queryCondition.objDataType,
          sectionId: _this.queryCondition.sectionId,
          pageNum: _this.queryCondition.pageNum,
          pageSize: _this.queryCondition.pageSize
        };
        MonitorDataService.objDetailDatagrid(Params).then(
          (result) => {
            _this.Obj = [];
            result.list.forEach(a => {
              let temp = {};
              temp.ObjName = a.name;
              temp.id = a.id;
              temp.clickStatus = false;
              temp.objtypeId = a.objtypeId;
              temp.ObjVal = false;
              temp.objtypeIds = _this.queryCondition.objDataType;
              temp.datatypeId = a.datatypeId;
              if (a.datatypeId == 1) {
                temp.ObjVal = a.cv.toFixed(2);
                _this.queryCondition.showSwitch = false;
              } else {
                temp.ObjVal = a.cv;
                _this.queryCondition.showSwitch = true;
              }
              temp.objtypeName =
                _this.curName +
                _this.curSotre.name +
                "---" +
                a.objtypeName;
              _this.Obj.push(temp);
            });
            _this.queryCondition.total = result.total;
            _this.queryCondition.pageNum = result.pageNum;
          },
          (error) => {
            console.log(error)
          })
      },
      //切换页面
      changePage(index) {
        let _this = this;
        _this.queryCondition.pageNum = index;
        _this.getObjDetialData();
      },
      //切换页码数
      handlePageSize(value) {
        this.queryCondition.pageSize = value;
        this.getObjDetialData();
      },

      setGIS() {
        var gis = document.getElementById("newID");
        gis.style.display = "block";
        gis.style.position = 'absolute';
        gis.style.top = '0px';
        gis.style.height = '100%';
        gis.style.width = '98%'
        document.body.removeChild(gis)
        document.getElementById("GISbox").appendChild(gis)
        // 加载视角
        this.$refs.smViewer1.setViewAngAngle();
      },

      destory3D() {
        var gis = document.getElementById("newID");
        gis.style.display = "none";
        document.getElementById("GISbox").removeChild(gis)
        document.body.appendChild(gis)
      }
    },
    beforeDestroy() {
      this.destory3D()
    }
  }
</script>


<style scoped>
  .map {
    width: 42vw;
    height: calc(85vh - 100px - 20px);
    margin-left: 10px;
  }

  .data {
    height: calc(85vh - 100px - 20px - 40px);
  }

  .smallData {
    height: calc(85vh - 100px - 20px - 40px - 40px);
  }

  .top {
    margin: 10px;
    line-height: 50px;
    background: #dfe5e5;
    padding-left: 10px;
  }

  .bottom {
    background: #fff;
    margin-top: 10px;
    padding: 10px;
  }

  .ivu-modal-wrap > .ivu-modal {
    left: 500px;
    top: 500px;
  }

  .ivu-tabs.ivu-tabs-card > .ivu-tabs-bar .ivu-tabs-tab {
    background: #adb3e2;
    color: #fff;
  }

  .Section #pageBox {
    border: 1px solid #b3b0b0;
    bottom: 0px;
    width: 83.5vw;
    left: 0px;
    text-align: center;
    overflow-x: hidden;
  }

  .showSection {
    display: inline-block;
    line-height: 35px;
  }

  .showSection {
    overflow: hidden;
    padding-left: 20%;
  }

  .showSection ul li {
    display: inline-block;
    border-right: 1px solid #b3b0b0;
    line-height: 35px;
    text-align: center;
  }

  .showSection ul li {
    width: 100px;
  }

  .tunnelsInfo,
  .environmentalMonitoring,
  .theFireWarning,
  .monitoringSituation {
    margin: 0.5vw;
    border: 1px solid #b3b0b0;
    border-radius: 8px;
    padding-left: 20px;
    box-shadow: 5px 6px 4px rgba(0, 0, 0, 0.2);
    border-color: #eee;
  }

  .tunnelsInfo div,
  .environmentalMonitoring div,
  .theFireWarning div,
  .monitoringSituation div {
    line-height: 5vh;
    font-size: 14px;
  }

  .title {
    font-size: 20px !important;
    text-align: center;
    font-weight: 700;
    margin-top: 5px;
  }

  .inline-box div {
    display: inline-block;
  }

  .normal {
    width: 15px !important;
    height: 15px !important;
    border-radius: 100%;
    background: green;
  }

  .abnormal {
    width: 15px !important;
    height: 15px !important;
    border-radius: 100%;
    background: red;
  }

  .numerical {
    width: 60%;
  }

  .status {
    width: 20%;
  }

  .nextPage {
    position: relative;
    bottom: 0px;
    float: right;
  }
</style>
